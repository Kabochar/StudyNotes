计算机网络协议 - 刘超 - 极客时间

## OSI 五层具体网络协议

-   应用层：DHCP，HTTP，HTTPS，RTMP，P2P，DNS，GTP，RPC
-   传输层：UDP，TCP
-   网络层：ICMP，IP，OSFP，BGP，IPSec，GRE
-   链路层：ARP，VLAN，STP
-   物理层：网络跳线

## 网络 why to 分层？网络为什么要分层？

因为，是个复杂的程序都要分层。

## 程序如何工作？

![1555723642205](pics\1555723642205.png)

## TCP 在三次握手的时候，IP 层 和 MAC 层在做什么？

过程：TCP 每发送一个消息，都会带着 IP 层 和 MAC 层。

因为，TCP 每发送一个消息，IP 层和 MAC 层的所有机制都要运行一遍。

## 网路包机制

只要在网络上跑的包，都是完整的。可以有下层没上层，但绝不能有上层没下层的。（一个 HTTP 协议的包跑在网络上，它一定是完整的。无论这个包经过哪些设备，它都 是完整的。）

所以，对于 TCP 协议，三次握手也好，重试也好，只要想发出去包，就得有 IP 层 和 MAC 层，不然是发不出去的。

## 二层设备、三层设备

所谓的二层设备，三层设备，都是这些设备上跑的程序不同而已。一个 HTTP 协议的包经过一个二层设备，二层设备接收进去的是整个网络包。这里面 HTTP，TCP，IP，MAC 都有。

what is 二层设备？就只是把 MAC 头摘下来，看看到底是 丢弃，转发，还是自己留着。

what is 三层设备？把 MAC 头摘下来后， 再看看到底是 丢弃，转发，还是自己留着。

## 怎么查看 IP 地址？

Windows 是  ipconfig，Linux 是 ifconfig （或 ip addr）

打破几类地址的做法？

无类型域间选路（CIDR）。它将 32 位 IP 地址一分为二，前面是网络号，后面是主机号。

举例：10.100.122.2/24，这个 IP 地址中有一个斜杠，斜杠后面有个数字 24。这种地址表示形式，就是 CIDR。后面 24 的意思是，32 位中，前 24 位是网络号，后 8 位 是主机号。

## MAC 地址详解

MAC 是一个唯一的标识，具有一定的定位功能，但范围有限。通常 MAC 地址的通信范围小，局限在一个子网里面，一旦跨子网，这时需要 IP 地址起作用了。

## 网络设备的状态标识

< BROADCAST,MULTICAST,UP,LOWER_UP > 是干什么 的？这个叫作net_device flags，网络设备的状态标识。

UP 表示网卡处于启动的状态；BROADCAST 表示这个网卡有广播地址，可以发送广播包； MULTICAST 表示网卡可以发送多播包；LOWER_UP 表示 L1 是启动的，也即网线插着呢。

## 小结-IP&CIDR

IP 是地址，有定位功能；MAC 是身份证，无定位功能；

CIDR 可以用来判断是不是本地人；

IP 分为共有的 IP 和 私有的 IP。

## 如何配置 IP 地址？

使用 net-tools：

```
$ sudo ifconfig eth1 10.0.0.1/24 
$ sudo ifconfig eth1 up 
```

使用 iproute2

```
$ sudo ip addr add 10.0.0.1/24 dev eth1 
$ sudo ip link set up eth1 
```

Linxu 默认的逻辑是，如果这时一个跨网段的调用，它便不会直接将包发送到网络上，而是企图将包发送到网关。

>   当你需要手动配置一台机器的网络 IP 时，一定要好好问问你的网络管理员。
>
>   如果在机房 里面，要去网络管理员那里申请，让他给你分配一段正确的 IP 地址。
>
>   当然，真正配置的时候， 一定不是直接用命令配置的，而是放在一个配置文件里面。
>
>   不同系统的配置文件格式不同，但是 无非就是 CIDR、子网掩码、广播地址和网关地址。

## 动态主机配置协议（DHCP）

动态主机配置协议（Dynamic Host Configuration Protocol），简称DHCP：一个自动可以配置 IP 地址 的 协议。

>   网络管理员就轻松了。他只需要配置一段共享的 IP 地址。每一台新接入的机 器都通过 DHCP 协议，来这个共享的 IP 地址里申请，然后自动配置好就可以了。等人走了，或 者用完了，还回去，这样其他的机器也能用。

## 解析 DHCP 的工作方式 

在这个广播包里面，新人大声喊：我是新来的（Boot request），我的 MAC 地址是这个，我 还没有 IP，谁能给租给我个 IP 地址！

![1555751196643](pics\1555751196643.png)

只有 MAC 唯一，IP 管理员才能知道这是一个新人，需要租给它一个 IP 地址，这个过程我们称 为DHCP Offer。同时，DHCP Server 为此客户保留为它提供的 IP 地址，从而不会为其他 DHCP 客户分配此 IP 地址。

DHCP Offer 的格式就像这样，里面有给新人分配的地址。

![1555751292126](pics\1555751292126.png)

它会选择其中一个 DHCP Offer，一般是先到达的那个，并且会向网络发送一个 DHCP Request 广播数据包，包中包含客户端的 MAC 地址、接受的租约中的 IP 地址、提供此租约的 DHCP 服务器地址等，并告诉所有 DHCP Server 它将接受哪一台服务器提供的 IP 地址，告诉 其他 DHCP 服务器，谢谢你们的接纳，并请求撤销它们提供的 IP 地址，以便提供给下一个 IP 租用请求者。

当 DHCP Server 接收到客户机的 DHCP request 之后，会广播返回给客户机一个 DHCP ACK 消息包，表明已经接受客户机的选择，并将这一 IP 地址的合法租用信息和其他的配置信息都放 入该广播包，发给客户机，欢迎它加入网络大家庭。

![1555751515223](pics\1555751515223.png)

终租约达成的时候，还是需要广播一下，让大家都知道。

## IP 地址的收回和续租 

客户机会在租期过去 50% 的时候，直接向为其提供 IP 地址的 DHCP Server 发送 DHCP request 消息包。客户机接收到该服务器回应的 DHCP ACK 消息包，会根据包中所提供的新的 租期以及其他已经更新的 TCP/IP 参数，更新自己的配置。这样，IP 租用更新就完成了。

## 预启动执行环境（PXE）

安装操作系统的过程，只能插在 BIOS 启动之后了。因为没安装系统之前，连启动扇区都 没有。因而，这个过程叫做预启动执行环境（Pre-boot Execution Environment），简称PXE。

PXE 协议分为客户端和服务器端，由于还没有操作系统，只能先把客户端放在 BIOS 里面。

当计 算机启动时，BIOS 把 PXE 客户端调入内存里面，就可以连接到服务端做一些操作了。

## 解析 PXE 的工作过程 

首先，启动 PXE 客户端。第一步是通过 DHCP 协议告诉 DHCP Server，我刚来，一穷二白， 啥都没有。DHCP Server 便租给它一个 IP 地址，同时也给它 PXE 服务器的地址、启动文件 pxelinux.0。

其次，PXE 客户端知道要去 PXE 服务器下载这个文件后，就可以初始化机器。

于是便开始下 载，下载的时候使用的是 TFTP 协议。所以 PXE 服务器上，往往还需要有一个 TFTP 服务器。 PXE 客户端向 TFTP 服务器请求下载这个文件，TFTP 服务器说好啊，于是就将这个文件传给 它。

然后，PXE 客户端收到这个文件后，就开始执行这个文件。这个文件会指示 PXE 客户端，向 TFTP 服务器请求计算机的配置信息 pxelinux.cfg。TFTP 服务器会给 PXE 客户端一个配置文 件，里面会说内核在哪里、initramfs 在哪里。PXE 客户端会请求这些文件。

好，启动 Linux 内核。一旦启动了操作系统，以后就啥都好办了。

![1555751763895](pics\1555751763895.png)

## 小结-DHCP

-   DHCP 协议主要是用来给客户租用 IP 地址，和房产中介很像，需要 商谈、签约，续租、广播 而且不能 ”抢单“
-   DHCP 协议能给客户推荐 ”装修队“ PXE ，能够安装操作系统，这个在云计算大有作为。

## 小结-MAC-ARP

三个重点：

1，MAC 层是用来解决多路访问的堵车问题。

2，ARP 协议 是通过 吼 的方式来寻找目标 MAC 地址的，吼 完之后记住一段时间，这个叫做 缓存。

3，交换机是有 MAC 地址学习能力的，学完了它就知道谁在哪儿了，不用广播了。

>   发给谁，谁接收？需要用到一个物理地址，叫作 链路层地址。但是因为 第二层 主要解决媒体接入控制的问题，所以它常被称为MAC 地址。
>
>   怎么知道每个 MAC 地址是谁呢？这就是 ARP 协议，也就是已知 IP 地址，求 MAC 地址的协议。
>
>   MAC的全称是 Medium Access Control，即媒体访问控制。控制什么呢？其实就是控制在往媒体上发数据的时候，谁 先发、谁后发的问题。防止发生混乱。

## 拓扑结构是怎么形成的？ 

大型的办公室，一个交换机肯定不够用，需要多台交换机，交换机之间连接起来，就形成一个 稍微复杂的拓扑结构。如何解决常见的环路问题？ STP 协议

## STP 协议

-   Root Bridge，也就是根交换机。“掌门”交换机，是某棵树 的老大，是掌门，最大的大哥。
-   Designated Bridges，有的翻译为指定交换机。想像成一个“小 弟”，对于树来说，就是一棵树的树枝。
-   Bridge Protocol Data Units （BPDU） ，网桥协议数据单元。可以比喻为“相互比较实 力”的协议。BPDU 只有掌门能发，已经隶属于某个掌门的交换 机只能传达掌门的指示。
-   Priority Vector，优先级向量。可以比喻为实力 （值越小越牛）。实力是啥？就是一组 ID 数目，[Root Bridge ID, Root Path Cost, Bridge ID, and Port ID]。为什么这样设计呢？这 是因为要看怎么来比实力。

## STP 的工作过程是怎样的？

最终，生成一棵树，武林一统，天下太平。但是天下大势，分久必合，合久必分，天下统一久 了，也会有相应的问题。

## 如何解决广播问题和安全问题？ 

有两种分的方法，

一个是物理隔离。每个部门设一个单独的会议室，对应到网络方面，就是每个 部门有单独的交换机，配置单独的子网，这样部门之间的沟通就需要路由器了。

另外一种方式是虚拟隔离，就是用我们常说的VLAN，或者叫虚拟局域网。

使用 VLAN，一个交 换机上会连属于多个局域网的机器，那交换机怎么区分哪个机器属于哪个局域网呢？只需要在原来的二层的头上加一个 TAG，里面有一个 VLAN ID，一共 12 位。为什么是 12 位呢？因为 12 位可以划分 4096 个 VLAN。

## 小结

-   当交换机的数目越来越多的时候，会遭遇环路问题，让网络包迷路，这就需要使用 STP 协议，通过 华山论剑比武的方式，将有环路的图编程没有环路的树，从而解决环路问题。
-   交换机数据多会面临隔离问题，可以通过 VLAN 形成虚拟局域网，从而解决广播问题和安全问题。

## ICMP 协议格式

ping 是基于 ICMP 协议工作的。ICMP全称Internet Control Message Protocol，就是互联网 控制报文协议。

ICMP 报文是封装在 IP 包里面的。因为传输指令的时候，肯定需要源地址和目标地址。

## 查询报文类型

主帅发起的，主动查看敌情，对应 ICMP 的查询报文类型。

对 ping 的主动请求，进行网络抓包，称为 ICMP ECHO REQUEST。同理主动请求的回复，称 为ICMP ECHO REPLY。比起原生的 ICMP，这里面多了两个字段，一个是标识符。

## 差错报文类型

差错报文的结构相对复杂一些。除了前面还是 IP，ICMP 的前 8 字节不变，后面则跟上出错的 那个 IP 包的 IP 头和 IP 正文的前 8 个字节。

## ping：查询报文类型的使用 

![1555813521615](pics\1555813521615.png)

在规定的时候间内，源主机如果没有接到 ICMP 的应答包，则说明目标主机不可达；如果接收 到了 ICMP 应答包，则说明目标主机可达。此时，源主机会检查，用当前时刻减去该数据包最 初从源主机上发出的时刻，就是 ICMP 数据包的时间延迟。

ping 这个程序是使用了 ICMP 里面的 ECHO REQUEST 和 ECHO REPLY 类型的。

## Traceroute：差错报文类型的使用 

Traceroute，是个“大骗子”。它会使用 ICMP 的规则，故意制造一些能够产生错误的场景。

Traceroute 的第一个作用就是故意设置特殊的 TTL，来追踪去往目的地时沿途经过的路由器。Traceroute 的参数指向某个目的 IP 地址，它会发送一个 UDP 的数据包。将 TTL 设置成 1，也就是说一旦遇到一个路由器或者一个关卡，就表示它“牺牲”了。

Traceroute 还有一个作用是故意设置不分片，从而确定路径的 MTU。要做的工作首先是发送分 组，并设置 “不分片” 标志。

## 小结

-   ICMP 相当于网络世界的侦察兵。两种类型的 ICMP 报文，一种是主动探查的查询报 文，一种异常报告的差错报文； 
-   ping 使用查询报文，Traceroute 使用差错报文。

## MAC 头和 IP 头的细节

一旦配置了 IP 地址和网关，往往就能够指定目标地址进行访问了。

![1555814506009](D:\Documents\笔记本\offer学习复习\计算机网络协议-刘超-极客时间\1555814506009.png)

在 MAC 头里面，先是目标 MAC 地址，然后是源 MAC 地址，然后有一个协议类型，用来说明 里面是 IP 协议。

IP 头里面的版本号，目前主流的还是 IPv4，服务类型 TOS 在 ip addr 命令讲过，TTL 在 ICMP 协议讲过。另外，还有 8 位标识协议。这里到了下一层的协议，也就是，是 TCP 还是 UDP。最重要的就是源 IP 和目标 IP。先是源 IP 地 址，然后是目标 IP 地址。

在任何一台机器上，当要访问另一个 IP 地址的时候，都会先判断，这个目标 IP 地址，和当前机 器的 IP 地址，是否在同一个网段。怎么判断同一个网段呢？需要 CIDR 和子网掩码

网关往往是一个路由器，是一个三层转发的设备。啥叫三层设备？前面也说过了，就是把 MAC 头和 IP 头都取下来，然后根据里面的内容，看看接下来把包往哪里转发的设备。

任何一个想发往其他局域网的包，都会到达其中一只手，被拿进来，拿下 MAC 头和 IP 头，看 看，根据自己的路由算法，选择另一只手，加上 IP 头和 MAC 头，然后扔出去。

## 路由 and 网关

路由器是一 台设备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。每只手的 IP 地址都 和局域网的 IP 地址相同的网段，每只手都是它握住的那个局域网的网关。

## 静态路由是什么？

静态路由，其实就是在路由器上，配置一条一条规则。每当要选择从哪只手抛出去的时候，就一条一条的匹配规则，找到符合的规则，就按规则中设置 的那样，从某个口抛出去，找下一跳 IPX。

## IP 头和 MAC 头哪些变、哪些不变？ 

MAC 地址是一个局域网内才有效的地址。因而，MAC 地址只要过网关，就必定 会改变，因为已经换了局域网。两者主要的区别在于 IP 地址是否改变。不改变 IP 地址的网关， 我们称为转发网关；改变 IP 地址的网关，我们称为NAT 网关。

## 小结

-   如果离开本局域网，就需要经过网关，网关是路由器的一个网口；
-   路由器是一个三层设备，里面有如何寻找下一跳的规则；

-   经过路由器之后 MAC 头要变，如果 IP 不变，相当于不换护照的欧洲旅游，如果 IP 变，相 当于换护照的玄奘西行。












































































































































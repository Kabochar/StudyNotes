# 字符集和比较规则

## 字符集和比较规则简介

### 字符集简介

`字符集`指的是某个字符范围的编码规则。

怎么存储字符串呢？建立字符与二进制数据的映射关系。

你要把哪些字符映射成二进制数据？界定清楚字符范围。

怎么映射？将一个字符映射成一个二进制数据的过程也叫做`编码`，将一个二进制数据映射到一个字符的过程叫做`解码`。

### 比较规则简介

`比较规则`是针对某个字符集中的字符比较大小的一种规则。

在`MySQL`中，一个字符集可以有若干种比较规则，其中有一个默认的比较规则，一个比较规则必须对应一个字符集。

### 一些重要的字符集

-   `ASCII`字符集

    -   共收录128个字符，使用1个字节来进行编码

-   `ISO 8859-1`字符集

    -   共收录256个字符，使用1个字节来进行编码

-   `GB2312`字符集
    -   如果该字符在`ASCII`字符集中，则采用1字节编码。

    -   否则采用2字节编码。

        >   同时这种字符集又兼容`ASCII`字符集。
        >
        >   如何判断字节数？
        >
        >   如果某个字节是在0～127之内的，就意味着一个字节代表一个单独的字符，否则就是两个字节代表一个单独的字符。

-   `GBK`字符集
    -   对`GB2312`字符集作了扩充
    -   编码方式上兼容`GB2312`。

-   `utf8`字符集

    -   兼容`ASCII`字符集

    -   编码一个字符需要使用1～4个字节

        >   utf8 只是 Unicode字符集的一种编码方案

## MySQL中支持的字符集和排序规则

### MySQL中  utf8 and utf8mb4

在`MySQL`中`utf8`是`utf8mb3`的别名，所以之后在`MySQL`中提到`utf8`就意味着使用1~3个字节来表示一个字符，如果大家有使用4字节编码一个字符的情况，比如存储一些emoji表情啥的，那请使用`utf8mb4`。

-   `utf8mb3`（utf8）：阉割过的`utf8`字符集，只使用1～3个字节表示字符。
-   `utf8mb4`：正宗的`utf8`字符集，使用1～4个字节表示字符。

### 字符集的查看

查看当前`MySQL`中支持的字符集可以用下边这个语句：

```
SHOW (CHARACTER SET|CHARSET) [LIKE 匹配的模式];
```

注意返回结果中的最后一列`Maxlen`，它代表该种字符集表示一个字符最多需要几个字节。

常用到的字符集的`Maxlen`列摘抄如下：

| 字符集名称 | Maxlen |
| :--------: | :----: |
|  `ascii`   |  `1`   |
|  `latin1`  |  `1`   |
|  `gb2312`  |  `2`   |
|   `gbk`    |  `2`   |
|   `utf8`   |  `3`   |
| `utf8mb4`  |  `4`   |

### 比较规则的查看

查看`MySQL`中支持的比较规则的命令如下：

```
SHOW COLLATION [LIKE 匹配的模式];
```

查看一下`utf8`字符集下的比较规则：

```
SHOW COLLATION LIKE 'utf8\_%'
```

每种字符集对应若干种比较规则，每种字符集都有一种默认的比较规则。

`SHOW COLLATION`的返回结果中的`Default`列的值为`YES`的就是该字符集的默认比较规则

## 字符集和比较规则的应用

### 各级别的字符集和比较规则

`MySQL`有4个级别的字符集和比较规则，分别是：

#### 服务器级别

`MySQL`提供了两个系统变量来表示服务器级别的字符集和比较规则：

|        系统变量        |         描述         |
| :--------------------: | :------------------: |
| `character_set_server` |  服务器级别的字符集  |
|   `collation_server`   | 服务器级别的比较规则 |

这两个系统变量的值：

```
SHOW VARIABLES LIKE 'character_set_server';
SHOW VARIABLES LIKE 'collation_server';
```

可以在启动服务器程序时通过启动选项或者在服务器程序运行过程中使用`SET`语句修改这两个变量的值。比如我们可以在配置文件中这样写：

```
[server]
character_set_server=gbk
collation_server=gbk_chinese_ci
```

#### 数据库级别

创建和修改数据库时可以指定字符集和比较规则：

```
CREATE DATABASE 数据库名
    [[DEFAULT] CHARACTER SET 字符集名称]
    [[DEFAULT] COLLATE 比较规则名称];

ALTER DATABASE 数据库名
    [[DEFAULT] CHARACTER SET 字符集名称]
    [[DEFAULT] COLLATE 比较规则名称];
```

>   其中的`DEFAULT`可以省略，并不影响语句的语义。

查看当前数据库使用的字符集和比较规则，可以查看下面两个系统变量的值

|         系统变量         |         描述         |
| :----------------------: | :------------------: |
| `character_set_database` |  当前数据库的字符集  |
|   `collation_database`   | 当前数据库的比较规则 |

```
USE charset_demo_db;
SHOW VARIABLES LIKE 'character_set_database';
SHOW VARIABLES LIKE 'collation_database';
```

注意的一点是：***character_set_database*** 和 ***collation_database*** 这两个系统变量是只读的，我们不能通过修改这两个变量的值而改变当前数据库的字符集和比较规则。

另外，数据库的创建语句中也可以不指定字符集和比较规则

#### 表级别

创建和修改表的时候指定表的字符集和比较规则：

```
CREATE TABLE 表名 (列的信息)
    [[DEFAULT] CHARACTER SET 字符集名称]
    [COLLATE 比较规则名称]]

ALTER TABLE 表名
    [[DEFAULT] CHARACTER SET 字符集名称]
    [COLLATE 比较规则名称]
```

如果创建和修改表的语句中没有指明字符集和比较规则，将使用该表所在数据库的字符集和比较规则作为该表的字符集和比较规则。

#### 列级别

对于存储字符串的列，同一个表中的不同的列也可以有不同的字符集和比较规则。

创建和修改列定义的时候可以指定该列的字符集和比较规则：

```
CREATE TABLE 表名(
    列名 字符串类型 [CHARACTER SET 字符集名称] [COLLATE 比较规则名称],
    其他列...
);

ALTER TABLE 表名 MODIFY 列名 字符串类型 [CHARACTER SET 字符集名称] [COLLATE 比较规则名称];
```

对于某个列来说，如果在创建和修改的语句中没有指明字符集和比较规则，将使用该列所在表的字符集和比较规则作为该列的字符集和比较规则。

>   在转换列的字符集时需要注意，如果转换前列中存储的数据不能用转换后的字符集进行表示会发生错误。

#### 仅修改字符集或仅修改比较规则

如果只修改了比较规则，字符集也会跟着变化，具体规则如下：（单独修改，对应改变为默认情况）

-   只修改字符集，则比较规则将变为修改后的字符集默认的比较规则。
-   只修改比较规则，则字符集将变为修改后的比较规则对应的字符集。

不论哪个级别的字符集和比较规则，这两条规则都适用

#### 各级别字符集和比较规则小结

4个级别字符集和比较规则的联系如下：（创建or修改没有指定，直接使用默认情况）

-   如果创建或修改  列 时没有显式的指定字符集和比较规则，则该列默认用  表 的字符集和比较规则
-   如果创建或修改  表 时没有显式的指定字符集和比较规则，则该表默认用  数据库 的字符集和比较规则
-   如果创建或修改  数据库 时没有显式的指定字符集和比较规则，则该数据库默认用  服务器 的字符集和比较规则

对于给定的表，该知道它的各个列的字符集和比较规则是什么，从而根据这个列的类型来确定存储数据时每个列的实际数据占用的存储空间大小了。

### 客户端和服务器通信中的字符集

#### 编码和解码使用的字符集不一致的后果

字符串在计算机上的体现就是一个字节串，如果你使用不同字符集去解码这个字节串，最后得到的结果可能让你挠头。

如果对于同一个字符串编码和解码使用的字符集不一样，会产生意想不到的结果

#### 字符集转换的概念

字符串`'我'`从`utf8`字符集转换为`gbk`字符集。这个过程称为`字符集的转换`

#### MySQL中字符集的转换

从客户端发往服务器的请求本质上就是一个字符串，服务器向客户端返回的结果本质上也是一个字符串，而字符串其实是使用某种字符集编码的二进制数据。

在这个过程中会用到3个系统变量

|          系统变量          |                             描述                             |
| :------------------------: | :----------------------------------------------------------: |
|   `character_set_client`   |                 服务器解码请求时使用的字符集                 |
| `character_set_connection` | 服务器处理请求时会把请求字符串从`character_set_client`转为`character_set_connection` |
|  `character_set_results`   |             服务器向客户端返回数据时使用的字符集             |

```
SHOW VARIABLES LIKE 'character_set_client';
SHOW VARIABLES LIKE 'character_set_connection';
SHOW VARIABLES LIKE 'character_set_results';
```

一般情况下客户端所使用的字符集和当前操作系统一致，不同操作系统使用的字符集可能不一样，如下：

-   类`Unix`系统使用的是`utf8`
-   `Windows`使用的是`gbk`

在请求从发送到结果返回过程中字符集的变化：

![1559958953539](pics\1559958953539.png)

几点需要注意的地方：

-   服务器认为客户端发送过来的请求是用`character_set_client`编码的。

    客户端采用的字符集和 ***character_set_client*** 不一样的话，服务器可能无法理解我们发送的请求，更别谈处理这个请求了。

-   服务器将把得到的结果集使用`character_set_results`编码后发送给客户端。

    客户端采用的字符集和 ***character_set_results*** 不一样的话，结果就是在你的屏幕上出现乱码。

-   `character_set_connection`只是服务器在将请求的字节串从`character_set_client`转换为`character_set_connection`时使用

    该字符集包含的字符范围一定涵盖请求中的字符，要不然会导致有的字符无法使用`character_set_connection`代表的字符集进行编码，就会向用户发出一个警告。

为啥要转来转去的呢？不晕么？

所以我们通常都把 ***character_set_client*** 、***character_set_connection***、***character_set_results*** 这三个系统变量设置成和客户端使用的字符集一致的情况，这样减少了很多无谓的字符集转换。

`MySQL`提供了一条非常简便的语句：

```
SET NAMES 字符集名;
```

这一条语句产生的效果和我们执行这3条的效果是一样的：

```
SET character_set_client = 字符集名;
SET character_set_connection = 字符集名;
SET character_set_results = 字符集名;
```

>   如果你使用的是Windows系统，那应该设置成gbk。

配置文件里可以这么写：

```
[client]
default-character-set=utf8
```

### 比较规则的应用

`比较规则`的作用通常体现比较字符串大小的表达式以及对某个字符串列进行排序中，所以有时候也称为`排序规则`。

在对字符串做比较或者对某个字符串列做排序操作时没有得到想象中的结果，需要思考一下是不是`比较规则`的问题～


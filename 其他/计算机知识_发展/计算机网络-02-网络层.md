# 计算机网络-网络层

[TOC]

## 网络层IP协议相关

### IP协议

#### 虚拟互连网络

实际的计算机网络是错综复杂的
物理设备通过使用IP协议，屏蔽了物理网络之间的差异
当网络中的主机使用IP协议连接时，则无需关注网络细节

![1573030390832](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573030390832.png)

IP协议使得复杂的实际网络变为一个虚拟互连的网络
IP协议使得网络层可以屏蔽底层细节而专注网络层的数据转发
IP协议解决了在虚拟网络中数据报传输路径的问题

#### IP协议

##### 表示方式

>   使用点分十进制

-   MAC地址是永久固定的
-   IP地址会因网络环境而发生改变

![1573030513064](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573030513064.png)

IP地址长度为32位，常分成4个8位

IP地址常使用点分十进制来表示（0\~255.0\~255.0\~255.0\~255）

最大可以表示：2<sup>32</sup> = 4294961296

##### IP数据报划分

![1573030711394](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573030711394.png)

##### IP数据报具体内容

![1573030757974](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573030757974.png)

-   **版本**：占4位，指的是IP协议的版本，通信双方的版本必须一致，当前主流版本是4，即IPV4，也有IPv6
-   **首部位长度**：占4位，最大数值为15，表示的是IP首部长度，单位是“32位字”（4个字节），也即是IP首部最大长度为60字节
-   **总长度**：占16位，最大数值为65535，表示的是IP数据报总长度（IP首部+IP数据）
    -   数据链路层MTU最多可以发送1500字节的内容，如果IP数据报内容过长，会拆分成多个数据帧进行传输
-   标识
-   标志，标记是否可以拆分数据报
-   片偏移，记录是拆分的第几个数据
-   **TTL**：占8位，表明IP数据报文在网络中的寿命，每经过一个设备，TTL减1，当TTL=0时，网络设备必须丢弃该报文
    -   解决问题：当数据报文找不到终点时候，避免报文无限流通，消耗带宽，为此而设置寿命
-   协议：占8位，表明IP数据所携带的具体数据是什么协议的（如：TCP、UDP等）

![1573031086124](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573031086124.png)

-   首部校验和：占16位，校验IP首部是否有出错

### IP协议转发流程

#### 逐跳（hop-by-hop）

不断跳跃到下一个媒介，以达到最终的目标主机

![1573031464405](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573031464405.png)

#### 路由表简介

##### 回顾

>   重点关注路由表的作用

![1573031560187](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573031560187.png)

#### IP协议的转发流程

##### 转发方法如下

![1573031723907](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573031723907.png)

-   A 发出目的地为 C 的 IP 数据报，查询路由表发现下一跳为 E 
-   A 将数据报发送给E 
-   E 查询路由表发现下一跳为 F，将数据报发送给 F 
-   F 查询路由表发现目的地 C 直接连接，将数据报发送给 C

##### 配合路由表进行

>   网络层告知目的 MAC 地址都是查询ARP缓存得出来的

###### 第一步

-   A 发出目的地为 C 的 IP 数据报，查询路由表发现下一跳为 E
-   A 将 IP 数据报交给数据链路层，并告知目的 MAC 地址是 E
-   数据链路层填充源 MAC 地址 A 和目的 MAC 地址 E
-   数据链路层通过物理层将数据发送给 E

###### 第二步

-   E 的数据链路层接收到数据帧，把帧数据交给网络层
-   E 查询路由表，发现下一跳为 F 
-   E 把数据报交给数据链路层，并告知目的 MAC 地址为 F 
-   E 的数据链路层封装数据帧并发送

###### 第三步

-   F 的数据链路层接收到数据帧，把帧数据交给网络层
-   F 查询路由表，发现下一跳为 C 
-   F 把数据报交给数据链路层，并告知目的 MAC 地址为 C 
-   F 的数据链路层封装数据帧并发送

##### 注意点

-   数据帧每一跳的MAC地址都在变化
-   IP数据报每一跳的IP地址始终不变

### 子网划分



### 简单路由过程



## 网络层其他协议

### ARP协议与RARP协议

#### ARP协议

ARP（Address Resolution Protocol）地址解析协议

作用：网络层IP32位地址-->>ARP协议-->>数据链路层MAC48位地址

##### ARP缓存表

![1573032247843](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573032247843.png)

##### ARP缓存有无情况

-   ARP缓存表缓存有IP地址和MAC地址的映射关系
-   ARP缓存表没有缓存IP地址和MAC地址的映射关系

>   如果<u>网络层可以直接告知数据链路层目的MAC地址</u>意味是ARP有缓存的，反之缓存表里没有对应关系。
>
>   那如何处理缓存表没有对应关系的问题？
>
>   这时ARP协议可以广播某个IP的信息，收到回应的设备都会回应一个包，表示我是否是这个IP地址和MAC地址，这时候可以直接更新缓存

#### RARP协议

>   现在很少使用，仅作了解

RARP（Reverse Address Resolution Protocol）逆地址解析协议

作用：数据链路层MAC48位地址-->>RARP协议-->>网络层IP32位地址

![1573032858209](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573032858209.png)

#### 协议模型

![1573032694827](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573032694827.png)

ARP协议封装在数据帧中，为什么会属于网络层？

因为ARP协议带有IP协议，所以归于网络层，它是网络层和数据链路层配合使用的一个重要协议

#### 总结

-   ARP缓存表是ARP协议和RARP协议运行的关键
-   ARP缓存表缓存了IP地址到硬件地址之间的映射关系
-   ARP缓存表中的记录并不是永久有效的，有一定的期限（IP地址会发生变化）
-   （R）ARP协议是TCP/IP协议栈里面基础的协议（主要帮助网络层和数据链路层的配合工作）
    ARP和RARP的操作对程序员是透明的
-   理解（R）ARP协议有助于理解网络分层的细节

### ICMP协议



## IP的路由算法

### 路由的概述



### 内部网关路由协议



### 外部网关路由协议
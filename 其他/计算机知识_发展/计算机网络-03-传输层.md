# 计算机网络-传输层

[TOC]

## UDP

### UDP 协议详解

UDP（User Datagram Protocol：用户数据报协议）
UDP是一个非常简单的协议

>   数据报（Datagram），UDP 采用不合并，不拆分，直接装载进报文里

![1573136029107](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573136029107.png)

#### 协议模型

![1573136078963](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573136078963.png)

端口号：对应机器正在使用网络的进程

校验和：检测 UDP 的数据报是否出错

#### 特点

-   UDP是无连接协议
-   UDP不能保证可靠的交付数据
    -   “想发就发”，“无法保证数据在网络中是否丢失"
-   UDP是面向报文传输的
    -   不拆分，不合并，直接硬塞进数据报
-   UDP没有拥塞控制
    -   路黑照样走
-   UDP的首部开销很小
    -   只有五个主体内容

## TCP

### TCP 协议详解

-   TCP（Transmission Control Protocol：传输控制协议）
-   TCP协议是计算机网络中非常复杂的一个协议

#### 存在位置

![1573139026176](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573139026176.png)

#### 特点

TCP是面向连接的协议
TCP的一个连接有两端（点对点通信）
TCP提供可靠的传输服务

TCP协议提供全双工的通信
TCP是面向字节流的协议

![1573139078278](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573139078278.png)

#### 协议模型

![1573139152624](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573139152624.png)

##### 序号

-   0~2^32-1
-   一个字节一个序号
-   指的是 数据首字节序号
-   常配合确认号使用
-   ![1573139252423](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573139252423.png)

##### 确认号

-   0~2^32-1
-   一个字节一个序号
-   期望收到数据的首字节序号*
-   确认号为N：则表示N-1序号的数据都已经收到

-   已经收到 501-600 的数据，下次发送请从 601 开始
    -   ![1573139448141](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573139448141.png)

##### 数据偏移

-   占4位：0~15，单位为：32位字
-   数据偏离首部的距离（因为不知道TCP选项的确切长度，以此来记录）

##### TCP标记

-   占6位，每位各有不同意义

| 标记 | 含义                                           |
| ---- | ---------------------------------------------- |
| URG  | Urgent：紧急位，URG=1，表示紧急数据            |
| ACK  | Acknowledgement：确认位，ACK=1，确认号才生效   |
| PSH  | Push：推送位，PSH=1，尽快地把数据交付给应用层  |
| RST  | Reset：重置位，RST=1，重新建立连接             |
| SYN  | Synchronization：同步位，SYN=1表示连接请求报文 |
| FIN  | Finish：终止位，FIN=1表示释放连接              |

##### 窗口

-   占16位：0~2^16-1
-   窗口指明允许对方发送的数据量

##### 校验和

##### 紧急指针

-   紧急数据（URG=1）
-   指定紧急数据在报文的位置

##### TCP选项

-   最多40字节
-   支持未来的拓展

### 可靠传输基本原理

#### 停止等待协议

##### 数据传输理想态-无差错

![1573177655189](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573177655189.png)

##### 数据传输失败

![1573177730055](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573177730055.png)

##### 确认消息获取失败

![1573177793381](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573177793381.png)

##### 确认消息许久才收到

![1573177819671](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573177819671.png)

##### 可靠传输出现的三个原因

-   发送的消息在路上丢失了
-   确认的消息在路上丢失了
-   确认的消息很久才到

##### 超时定时器

每发送一个消息，都需要设置一个定时器

##### 总结

-   停止等待协议是最简单的可靠传输协议
-   停止等待协议对**信道的利用效率**不高
    -   发送方发送完成数据以后，需要停止等待接收方的确认消息，如果没有收到确认消息，会持续等待，这不利于有效率连接

#### 连续ARQ协议

-   ARQ（Automatic Repeat reQuest：自动重传请求）

既然单个发送和确认效率低，可不可以批量发送和确认？

##### 滑动窗口

-   窗口内的数据都可以发送
-   如果前面数据收到确认消息，窗口可以向前移动，以发送后面的内容
-   不需要每个字节都进行确认，而是采用一种累计确认的方法

![1573178341100](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573178341100.png)

##### 累计确认

-   如果收到 5 号数据的确认消息，表示5号数据前的数据都已经收到了，这时窗口可以直接从第 6 号数据开始发送
-   减少了确认报文的数据，提高了网络的利用效率

![1573178488002](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573178488002.png)

### TCP 协议可靠传输

#### TCP的可靠传输基于连续ARQ协议

-   TCP的可靠传输基于连续ARQ协议
-   TCP的滑动窗口以字节为单位

##### 结合TCP首部的确认号

![1573178782154](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573178782154.png)

收到确认消息窗口移动

>   23，24收到确认消息，窗口移动

![1573178895277](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573178895277.png)

##### 数据已发送但未收到确认消息(*怎么处理？)

>   全部未收到确认消息，窗口是不能移动的，可用窗口此时为0

![1573179006878](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573179006878.png)

##### 确认消息不是按序到达

-   23、24 没有收到
    -   此时窗口是不能移动的，尽管已经收到 25，27 的确认消息
-   从 23 开始重传
    -   如果重新发送整个窗口的内容，未免会造成浪费，选择重传此时生效了

![1573179193680](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573179193680.png)

#### 选择重传

-   选择特定的消息进行重传
-   选择重传需要指定需要重传的字节
-   每一个字节都有唯一的32位序号

-   如果存储选择需要重传的序号需要耗费很多空间，实际重传的数据是存储在 TCP 选项的
-   因为数据偏移的原因，限制于 TCP 首部的长度（最多 60 字节）
-   序号实际不是选择指定的某个字节的
-   选择重传更多时候是进行某一段数据的重传（指定两个边界进行，边界内的数据进行重传）

![1573179859666](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573179859666.png)

>   重传一段字节流

![1573180025621](D:\Documents\笔记本\offer学习复习\其他\计算机知识_发展\1573180025621.png)

### TCP 协议流量控制



### TCP 协议拥塞控制



### TCP 协议三次握手



### TCP 协议四次挥手
## Linux性能调优-CPU性能篇-1-平均负载

### 一，什么是 平均负载

正确定义：单位时间内，系统处于 可运行状态 和不 可中断状态 的 平均进程数。（它包括了正在使用 CPU 的进程，等待 CPU and 等待 IO 的进程）

错误理解：与CPU使用率有关

可运行状态的进程：正在使用 CPU or 正在等待 CPU 的 进程。即，ps 命令，处于 R 状态的进程。（Running or Runnable）

不可中断状态的进程：正处于内核态关键流程中的进程，并且这些流程是不可打断的。即，ps 命令，D 状态的进程。(Uninterruptible Sleep，也称为Disk Sleep)

平均活跃进程数：另一个角度，平均负载即是平均活跃进程数。实际上是活跃进程数的指数衰减平均值。

理想状态：每个 CPU 上都刚好运行着一个进程，即 平均负载数目 = CPU 个数

过载：平均负载高于 CPU 数量 70% 时

### 二，平均负载数值逻辑

-   如果1分钟、5分钟、15分钟的三个值基本相同，或者相差不大，那就说明系统负载很平稳。

-   但如果1分钟的值远小于15分钟的值，就说明系统最近1分钟的负载在减少，而过去15分钟内却有很大的负载。

-   反过来，如果1分钟的值远大于15分钟的值，就说明最近1分钟的负载在增加，这种增加有可能只是临时性的，也有可能还会持续增加下去，所以就需要持续观察。一旦1分钟的平均负载接近或超过了CPU的个数，就意味着系统正在发生过载的问题，这时就得分析调查是哪里导致的问题，并要想办法优化了。

### 三，平均负载与CPU使用率

>   查看 系统 CPU 核心数
>
>   `$ grep 'model name' /proc/cpuinfo | wc -l`

CPU 使用率，时单位时间内CPU 繁忙情况的统计，跟平均负载并不一定完全对应。

-   CPU密集型进程，使用大量CPU会导致平均负载升高，此时这两者是一致的；
-   I/O密集型进程，等待I/O也会导致平均负载升高，但CPU使用率不一定很高；
-   大量等待CPU的进程调度也会导致平均负载升高，此时的CPU使用率也会比较高。

### 四，平均负载案例分析

>   前情：
>
>   使用工具，stress and sysstat 
>
>   stress 是一个Linux系统压力测试工具，这里我们用作异常进程模拟平均负载升高的场景。
>
>   sysstat 包含了常用的Linux性能工具，用来监控和分析系统的性能。

#### 场景一：CPU密集型进程

$ stress --cpu 1 --timeout 600：模拟 CPU 100%

$ watch -d uptime：查看平均负载，-d 表示高亮显示变化的区域

$ mpstat -P ALL 5：查看CPU 使用率变化，-P ALL 表示监控所有 CPU，5 表示 每 5s 输出一组数据

$ pidstat -u 5 1：间隔 5s 后输出一组数据，查看 %CPU 高，%iowait 低的进程。

#### 场景二：I/O密集型进程

$ stress -i 1 --timeout 600：模拟 IO 压力

$ watch -d uptime：查看平均负载

$ mpstat -P ALL 5 1：显示所有 CPU 的指标，并在间隔 5 秒输出一组数据，查看 %iowait 数值，过高说明异常点在 IO 上

pidstat -u 5 1：间隔 5s 后输出一组数据，查看进程状态。查看 %wait 数据高，并且 %CPU 数据高的进程。

#### 场景三：大量进程的场景

$ stress -c 8 --timeout 600：模拟 8个进程

$ uptime：查看 平均负载度

$ pidstat -u 5 1：间隔 5s 后输出一组数据，查看 %CPU 使用高 的进程个数。
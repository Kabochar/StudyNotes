# 20丨当我们思考数据库调优的时候，都有哪些维度可以选择？

[TOC]

## 疑问

数据库调优的目标是什么？

如果要进行调优，都有哪些维度可以选择？

如何思考和分析数据库调优这件事？

## 数据库调优的目标

数据库调优的目的就是要让数据库运行得更快，也就是说响应的时间更快，吞吐量更大。

## 如何更加精细的定位，去确定调优的目标

### 通过获得反馈

-   用户的反馈
    -   他们的反馈是最直接的。虽然他们不会直接提出技术建议
-   日志分析
    -   查看数据库日志和操作系统日志

### 通过监控运行状态

-   服务器资源使用监控
    -   服务器的 CPU、内存、I/O 等使用情况
-   数据库内部状况监控
    -   活动会话（Active Session）监控是一个重要的指标
    -   除了活动会话监控以外，我们也可以对事务、锁等待等进行监控

## 数据库调优，可以选择哪些维度？

调优的对象是整个数据库管理系统，它不仅包括 SQL 查询，还包括数据库的部署配置、架构等。

### 第一步，选择适合的 DBMS

在 RDBMS 中，常用的有 Oracle，SQL Server 和 MySQL 等。如果对事务性处理以及安全性要求高的话，可以选择商业的数据库产品。

NoSQL 阵营包括键值型数据库、文档型数据库、搜索引擎、列式存储和图形数据库。这些数据库的优缺点和使用场景各有不同

### 第二步，优化表设计

优化原则如下

-   表结构要尽量遵循第三范式的原则。
    -   可以让数据结构更加清晰规范，减少冗余字段，同时也减少了在更新，插入和删除数据时等异常情况的发生。
-   分析查询应用比较多，尤其是需要进行多表联查的时候，可以采用反范式进行优化。
    -   反范式采用空间换时间的方式，通过增加冗余字段提高查询的效率。
-   表字段的数据类型选择，关系到了查询效率的高低以及存储空间的大小。
    -   一般来说，如果字段可以采用数值类型就不要采用字符类型；字符长度要尽可能设计得短一些。针对字符类型来说，当确定字符长度固定时，就可以采用 CHAR 类型；当长度不固定时，通常采用 VARCHAR 类型。

好的表结构可以在业务发展和用户量增加的情况下依然发挥作用，不好的表结构设计会让数据表变得非常臃肿，查询效率也会降低。

### 第三步，优化逻辑查询

SQL 查询优化，可以分为逻辑查询优化和物理查询优化。逻辑查询优化就是通过改变 SQL 语句的内容让 SQL 执行效率更高效，采用的方式是对 SQL 语句进行等价变换，对查询进行重写。重写查询的数学基础就是关系代数。

SQL 的查询重写包括了子查询优化、等价谓词重写、视图重写、条件简化、连接消除和嵌套连接消除等。

### 第四步，优化物理查询

物理查询优化是将逻辑查询的内容变成可以被执行的物理操作符，从而为后续执行器的执行提供准备。它的核心是高效地建立索引，并通过这些索引来做各种优化。

索引不是万能的，我们需要根据实际情况来创建索引。但，有哪些情况需要考虑呢？

-   如果数据重复度高，就不需要创建索引。
-   要注意索引列的位置对索引使用的影响。
-   要注意联合索引对索引使用的影响。
-   要注意多个索引对索引使用的影响。
    -   索引不是越多越好，因为每个索引都需要存储空间，索引多也就意味着需要更多的存储空间。
    -   过多的索引也会导致优化器在进行评估的时候增加了筛选出索引的计算时间，影响评估的效率。

查询优化器在对 SQL 语句进行等价变换之后，还需要根据数据表的索引情况和数据情况确定访问路径，这就决定了执行 SQL 时所需要消耗的资源。

在物理查询优化阶段也需要确定这些查询所采用的路径，具体的情况包括

-   单表扫描：对于单表扫描来说，我们可以全表扫描所有的数据，也可以局部扫描。
-   两张表的连接：常用的连接方式包括了嵌套循环连接、HASH 连接和合并连接。
-   多张表的连接：多张数据表进行连接的时候，顺序很重要，因为不同的连接路径查询的效率不同，搜索空间也会不同。

物理查询优化是在确定了逻辑查询优化之后，采用物理优化技术（比如索引等），通过计算代价模型对各种可能的访问路径进行估算，从而找到执行方式中代价最小的作为执行计划

### 第五步，使用 Redis 或 Memcached 作为缓存

通常我们对于查询响应要求高的场景（响应时间短，吞吐量大），可以考虑内存数据库，毕竟术业有专攻。

### 第六步，库级优化

如果读和写的业务量都很大，并且它们都在同一个数据库服务器中进行操作，那么数据库的性能就会出现瓶颈，这时为了提升系统的性能，优化用户体验，我们可以采用读写分离的方式降低主数据库的负载，比如用主数据库（master）完成写操作，用从数据库（slave）完成读操作。

除此以外，我们还可以对数据库分库分表。当数据量级达到亿级以上时，有时候我们需要把一个数据库切成多份，放到不同的数据库服务器上，减少对单一数据库服务器的访问压力。如果你使用的是 MySQL，就可以使用 MySQL 自带的分区表功能，当然你也可以考虑自己做垂直切分和水平切分。

什么情况下做垂直切分，什么情况下做水平切分呢？

-   如果数据库中的数据表过多，可以采用垂直分库的方式，将关联的数据表部署在一个数据库上。
-   如果数据表中的列过多，可以采用垂直分表的方式，将数据表分拆成多张，把经常一起使用的列放到同一张表里。
-   如果数据表中的数据达到了亿级以上，可以考虑水平切分，将大的数据表分拆成不同的子表，每张表保持相同的表结构。

采用垂直分表的形式，就是将一张数据表分拆成多张表，采用水平拆分的方式，就是将单张数据量大的表按照某个属性维度分成不同的小表。

但需要注意的是，分拆在提升数据库性能的同时，也会增加维护和使用成本。

## 如何思考和分析数据库调优这件事

-   选择比努力更重要
    -   先选择 DBMS 和数据表的设计方式。
-   可以把 SQL 查询优化分成两个部分，逻辑查询优化和物理查询优化
    -   SQL 查询优化的技术有很多，但是大方向上完全可以分成逻辑查询优化和物理查询优化两大块。
    -   逻辑查询优化就是通过 SQL 等价变换提升查询效率，直白一点就是说，换一种查询写法执行效率可能更高。
    -   物理查询优化则是通过索引和表连接方式等技术来进行优化，这里重点需要掌握索引的使用。
-   通过外援来增强数据库的性能
    -   单一的数据库总会遇到各种限制，不如取长补短，利用外援的方式。
    -   通过对数据库进行垂直或者水平切分，突破单一数据库或数据表的访问限制，提升查询的性能。
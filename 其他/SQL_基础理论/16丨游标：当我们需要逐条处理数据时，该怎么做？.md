# 16丨游标：当我们需要逐条处理数据时，该怎么做？

[TOC]

## 前情

有一些情况，我们不需要对查询结果集中的所有数据行都采用相同的处理方式，需要每次处理一行或者一部分行，这时就需要面向过程的编程方法了。游标就是这种编程方式的体现。

## 疑问

什么是游标？我们为什么要使用游标？

如何使用游标？使用游标的常用步骤都包括哪些？

如何使用游标来解决一些常见的问题？

## 什么是游标？

在数据库中，游标是个重要的概念，它提供了一种灵活的操作方式，可以让我们从数据结果集中每次提取一条数据记录进行操作。

## 如何使用游标？

第一步，定义游标。

>   语法适用于 MySQL，SQL Server，DB2 和 MariaDB

```

DECLARE cursor_name CURSOR FOR select_statement
```

>   如果是用 Oracle 或者 PostgreSQL，需要写成

```

DECLARE cursor_name CURSOR IS select_statement
```

select_statement 代表的是 SELECT 语句

案例

```

DECLARE cur_hero CURSOR FOR 
  SELECT hp_max FROM heros;
```

第二步，打开游标

```

OPEN cursor_name
```

第三步，从游标中取得数据

```

FETCH cursor_name INTO var_name ...
```

使用 cursor_name 这个游标来读取当前行，并且将数据保存到 var_name 这个变量中，游标指针指到下一行。如果游标读取的数据行有多个列名，则在 INTO 关键字后面赋值给多个变量名即可。

第四步，关闭游标

```

CLOSE cursor_name
```

第五步，释放游标

```

DEALLOCATE cursor_namec 
```

一定要养成释放游标的习惯，否则游标会一直存在于内存中，直到进程结束后才会自动释放。当你不需要使用游标的时候，释放游标可以减少资源浪费。

## 使用游标来解决一些常见的问题

-   处理一些复杂的数据行计算的时候

## 总结

游标实际上是面向过程的思维方式，与面向集合的思维方式不同的地方在于，游标更加关注“如何执行”。我们可以通过游标更加精细、灵活地查询和管理想要的数据行。

使用游标可以更灵活，但同时也会带来一些性能问题，比如在使用游标的过程中，会对数据行进行加锁，这样在业务并发量大的时候，不仅会影响业务之间的效率，还会消耗系统资源，造成内存不足，这是因为游标是在内存中进行的处理。
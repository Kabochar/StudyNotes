# 26丨索引的使用原则：如何通过索引让SQL查询效率最大化？

[TOC]

## 疑问

什么情况下使用索引？当我们进行数据表查询的时候，都有哪些特征需要我们创建索引？

索引不是万能的，索引设计的不合理可能会阻碍数据库和业务处理的性能。那么什么情况下不需要创建索引？

创建了索引不一定代表一定用得上，甚至在有些情况下索引会失效。哪些情况下，索引会失效呢？又该如何避免这一情况？

## 创建索引有哪些规律？

-   字段的数值有唯一性的限制，比如用户名
    -   索引本身可以起到约束的作用
-   频繁作为 WHERE 查询条件的字段，尤其在数据表大的情况下
    -   创建普通索引就可以大幅提升数据查询的效率。
-   需要经常 GROUP BY 和 ORDER BY 的列
    -   多个单列索引在多条件查询时只会生效一个索引（MySQL 会选择其中一个限制最严格的作为索引），所以在多条件联合查询的时候最好创建联合索引。
    -   在进行 SELECT 查询的时候，先进行 GROUP BY，再对数据进行 ORDER BY 的操作，所以按照这个联合索引的顺序效率是最高的。
-   UPDATE、DELETE 的 WHERE 条件列，一般也需要创建索引
    -   因为我们需要先根据 WHERE 条件列检索出来这条记录，然后再对它进行更新或删除。如果进行更新的时候，更新的字段是非索引字段，提升的效率会更明显，这是因为非索引字段更新不需要对索引进行维护。
-   DISTINCT 字段需要创建索引
    -   索引会对数据按照某种顺序进行排序，所以在去重的时候也会快很多
-   做多表 JOIN 连接操作时，创建索引需要注意以下的原则
    -   连接表的数量尽量不要超过 3 张
        -   每增加一张表就相当于增加了一次嵌套的循环，数量级增长会非常快，严重影响查询的效率。
    -   对 WHERE 条件创建索引，因为 WHERE 才是对数据条件的过滤。
    -   对用于连接的字段创建索引，并且该字段在多张表中的类型必须一致。

## 什么时候不需要创建索引

-   WHERE 条件（包括 GROUP BY、ORDER BY）里用不到的字段不需要创建索引，索引的价值是快速定位，如果起不到定位的字段通常是不需要创建索引的。
-   表记录太少，比如少于 1000 个，那么是不需要创建索引的。
-   字段中如果有大量重复数据，也不用创建索引，比如性别字段。
-   频繁更新的字段不一定要创建索引。

## 什么情况下索引失效

-   如果索引进行了表达式计算，则会失效
-   如果对索引使用函数，也会造成失效
-   在 WHERE 子句中，如果在 OR 前的条件列进行了索引，而在 OR 后的条件列没有进行索引，那么索引会失效。
-   当我们使用 LIKE 进行模糊查询的时候，后面不能是 %
-   索引列尽量设置为 NOT NULL 约束。
    -   MySQL 官方文档建议尽量将数据表的字段设置为 NOT NULL 约束，这样做的好处是可以更好地使用索引，节省空间，甚至加速 SQL 的运行。
-   我们在使用联合索引的时候要注意最左原则

## 总结

要注意索引不是万能的。为了避免全表扫描，我们还需要注意有哪些情况可能会导致索引失效，这时就需要进行查询重写，让索引发挥作用。
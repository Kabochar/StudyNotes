# 29丨为什么没有理想的索引？

[TOC]

## 疑问

什么是索引片？如何计算过滤因子？

设计索引的时候，可以遵循哪些原则呢？

为什么理想的索引很难在实际工作中应用起来？

## 索引片和过滤因子

索引片就是 SQL 查询语句在执行中需要扫描的一个索引片段，我们会根据索引片中包含的匹配列的数量不同，将索引分成窄索引（比如包含索引列数为 1 或 2）和宽索引（包含的索引列数大于 2）。

如果索引片越宽，那么需要顺序扫描的索引页就越多；如果索引片越窄，就会减少索引访问的开销。

注意，每个非聚集索引保存的数据都会存储主键值，然后通过主键值，来回表查找相应的数据，因此每个索引都相当于包括了主键

## 如何通过宽索引避免回表

回表指的就是数据库根据索引找到了数据行之后，还需要通过主键再次到数据表中读取数据的情况。

可以通过宽索引将 SELECT 中需要用到的列（主键列可以除外）都设置在宽索引中，这样就避免了回表扫描的情况，从而提升 SQL 查询效率。

## 什么是过滤因子

在索引片的设计中，还需要考虑一个因素，那就是过滤因子，它描述了谓词的选择性。

在 WHERE 条件语句中，每个条件都称为一个谓词，谓词的选择性也等于满足这个条件列的记录数除以总记录数的比例。

联合过滤因子有更高的过滤能力，这里还需要注意一个条件，那就是条件列的关联性应该尽量相互独立，否则如果列与列之间具有相关性，联合过滤因子的能力就会下降很多。

过滤因子决定了索引片的大小（注意这里不是窄索引和宽索引），过滤因子的条件过滤能力越强，满足条件的记录数就越少，SQL 查询需要扫描的索引片也就越小。

## 针对 SQL 查询的理想索引设计：三星索引

三星索引具体指

-   在 WHERE 条件语句中，找到所有等值谓词中的条件列，将它们作为索引片中的开始列；
-   将 GROUP BY 和 ORDER BY 中的列加入到索引中；
-   将 SELECT 字段中剩余的列加入到索引片中。

三星索引的逻辑

-   最小化碎片
-   避免排序
-   避免回表查询

>   回表就是通过索引找到了数据行，但是还需要通过主键的方式在数据表中查找完成的记录。
>
>   这是因为 SELECT 所需的字段并不都保存在索引中，因此我们可以将 SELECT 中的字段都保存在索引中避免回表的情况，从而提升查询效率。

## 为什么很难存在理想的索引设计

原因主要有以下两点

-   采用三星索引会让索引片变宽，这样每个页能够存储的索引数据就会变少，从而增加了页加载的数量。
    -   数据量很大，比如有 1000 万行数据，过多索引所需要的磁盘空间可能会成为一个问题
-   增加了索引维护的成本。如果我们为所有的查询语句都设计理想的三星索引，就会让数据表中的索引个数过多，这样索引维护的成本也会增加。

## 总结

三星索引会让索引变宽，好处就是不需要进行回表查询，减少了磁盘 I/O 的次数，弊端就是会造成频繁的页分裂和页合并，对于数据的插入和更新来说，效率会降低不少。

该如何设计索引呢？

-   一张表的索引个数不宜过多。否则一条记录的增加和修改，会因为过多的索引造成额外的负担。
    -   针对这个情况，当你需要新建索引的时候，首先考虑在原有的索引片上增加索引，也就是采用复合索引的方式，而不是新建一个新的索引。
    -   另外可以定期检查索引的使用情况，对于很少使用到的索引可以及时删除，从而减少索引数量。
-   在索引片中，我们也需要控制索引列的数量
-   单列索引和复合索引的长度也需要控制
    -   如果单列索引长度超过了这个限制，就会取前缀索引，也就是取前 255 字符。
    -   字符列会占用较大的空间，在数据表设计的时候，尽量采用数值类型替代字符类型，尽量避免用字符类型做主键，同时针对字符字段最好只建前缀索引。
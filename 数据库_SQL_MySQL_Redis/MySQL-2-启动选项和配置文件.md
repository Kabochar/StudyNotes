# 启动选项和配置文件

#### 在命令行上使用选项

如果我们在启动服务器程序的时候就禁止各客户端使用`TCP/IP`网络进行通信，可以在启动服务器程序的命令行里添加`skip-networking`启动选项，就像这样：

```
mysqld --skip-networking
```

如果选项名是由多个单词构成的，它们之间可以由短划线`-`连接起来，也可以使用下划线`_`连接起来，也就是说`skip-networking`和`skip_networking`表示的含义是相同的。

在按照上述命令启动服务器程序后，再把服务器主机名指定为`127.0.0.1`（IP地址的形式）的话会显示连接失败：

```
mysql -h127.0.0.1 -uroot -p
Enter password:

ERROR 2003 (HY000): Can't connect to MySQL server on '127.0.0.1' (61)
```

在启动服务器程序的命令行后边指定启动选项的通用格式就是这样的：

```
--启动选项1[=值1] --启动选项2[=值2] ... --启动选项n[=值n]
```

对于不需要值的启动选项，它们就不需要指定对应的值。对于需要指定值的启动选项，在指定这个设置项的时候需要显式的指定它的值。

在命令行上指定有值的启动选项时需要注意，选项名、=、选项值之间不可以有空白字符，比如写成下边这样就是不正确的：

```
mysqld --default-storage-engine = MyISAM
```

每个MySQL程序都有许多不同的选项。大多数程序提供了一个--help选项，你可以查看该程序支持的全部启动选项以及它们的默认值。

##### 选项的长形式和短形式

|    长形式    | 短形式 | 含义     |
| :----------: | :----: | :------- |
|   `--host`   |  `-h`  | 主机名   |
|   `--user`   |  `-u`  | 用户名   |
| `--password` |  `-p`  | 密码     |
|   `--port`   |  `-P`  | 端口     |
| `--version`  |  `-V`  | 版本信息 |

选项名是区分大小写的，比如`-p`和`-P`选项拥有完全不同的含义，大家需要注意一下。

#### 配置文件中使用选项

`MySQL`程序在启动时会寻找多个路径下的配置文件，这些路径有的是固定的，有的是可以在命令行指定的。

**Windows操作系统的配置文件**

略

**类Unix操作系统中的配置文件**

在类`UNIX`操作系统中，`MySQL`会按照下列路径来寻找配置文件：

| 路径名                | 备注                                 |
| --------------------- | ------------------------------------ |
| `/etc/my.cnf`         |                                      |
| `/etc/mysql/my.cnf`   |                                      |
| `SYSCONFDIR/my.cnf`   |                                      |
| `$MYSQL_HOME/my.cnf`  | 特定于服务器的选项（仅限服务器）     |
| `defaults-extra-file` | 命令行指定的额外配置文件路径         |
| `~/.my.cnf`           | 用户特定选项                         |
| `~/.mylogin.cnf`      | 用户特定的登录路径选项（仅限客户端） |

-   `SYSCONFDIR`表示在使用`CMake`构建`MySQL`时使用`SYSCONFDIR`选项指定的目录。

-   `MYSQL_HOME`是一个环境变量，该变量的值是我们自己设置的。（可选）言外之意就是其他的配置文件既能存放服务器相关的选项也能存放客户端相关的选项，`.mylogin.cnf`除外，它只能存放客户端相关的一些选项。
-   通过指定`defaults-extra-file`参数的值来添加额外的配置文件路径

-   名为`.mylogin.cnf`配置文件有点儿特殊，它不是一个纯文本文件（其他的配置文件都是纯文本文件），而是使用`mysql_config_editor`实用程序创建的加密文件。文件中只能包含一些用于启动客户端软件时连接服务器的一些选项，包括 `host`、`user`、`password`、`port`和 `socket`。而且它只能被客户端程序所使用。

对于传递给`mysqld_safe`的启动选项来说，如果`mysqld_safe`程序不处理，会接着传递给`mysqld`程序处理。

比方说`skip-networking`选项是由`mysqld`处理的，`mysqld_safe`并不处理，但是如果我们我们在命令行上这样执行：

```
mysqld_safe --skip-networking
```

则在`mysqld_safe`调用`mysqld`时，会把它处理不了的这个`skip-networking`选项交给`mysqld`处理。

##### 配置文件的内容

配置文件中的启动选项被划分为若干个组，每个组有一个组名，用中括号`[]`扩起来，像这样：

```
[server]
(具体的启动选项...)

[mysqld]
(具体的启动选项...)
....
```

每个组下边可以定义若干个启动选项，我们以`[server]`组为例来看一下填写启动选项的形式（其他组中启动选项的形式是一样的）：

```
[server]
option1     #这是option1，该选项不需要选项值
option2 = value2      #这是option2，该选项需要选项值
...
```

配置文件中只能使用长形式的选项。在配置文件中指定的启动选项不允许加`--`前缀，并且每行只指定一个选项，而且`=`周围可以有空白字符（命令行中选项名、`=`、选项值之间不允许有空白字符）。内容使用`#`来添加注释，从`#`出现直到行尾的内容都属于注释内容，读取配置文件时会忽略这些注释内容。

配置文件中不同的选项组是给不同的启动命令使用的，如果选项组名称与程序名称相同，则组中的选项将专门应用于该程序。

不过有两个选项组比较特别：

-   `[server]`组下边的启动选项将作用于所有的服务器程序。
-   `[client]`组下边的启动选项将作用于所有的客户端程序。

为了直观感受一下，我们挑一些启动命令来看一下它们能读取的选项组都有哪些：

|    启动命令    |    类别    |                能读取的组                |
| :------------: | :--------: | :--------------------------------------: |
|    `mysqld`    | 启动服务器 |          `[mysqld]`、`[server]`          |
| `mysqld_safe`  | 启动服务器 | `[mysqld]`、`[server]`、`[mysqld_safe]`  |
| `mysql.server` | 启动服务器 | `[mysqld]`、`[server]`、`[mysql.server]` |
|    `mysql`     | 启动客户端 |          `[mysql]`、`[client]`           |
|  `mysqladmin`  | 启动客户端 |        `[mysqladmin]`、`[client]`        |
|  `mysqldump`   | 启动客户端 |        `[mysqldump]`、`[client]`         |

>   小贴士： 如果我们想指定mysql.server程序的启动参数，则必须将它们放在配置文件中，而不是放在命令行中。mysql.server仅支持start和stop作为命令行参数。

##### 特定MySQL版本的专用选项组

可以在选项组的名称后加上特定的`MySQL`版本号。只不过只有版本号为`5.7`的`mysqld`程序才能使用这个选项组中的选项。

##### 配置文件的优先级

如果我们在多个配置文件中设置了相同的启动选项，那以最后一个配置文件中的为准。

##### 同一个配置文件中多个组的优先级

我们说同一个命令可以访问配置文件中的多个组。那么，将以最后一个出现的组中的启动选项为准。

```
[server]
default-storage-engine=InnoDB

[mysqld]
default-storage-engine=MyISAM
```

##### defaults-file的使用

如果我们不想让`MySQL`到默认的路径下搜索配置文件（就是上表中列出的那些），可以在命令行指定`defaults-file`选项，比如这样（以`UNIX`系统为例）：

```
mysqld --defaults-file=/tmp/myconfig.txt
```

这样，在程序启动的时候将只在`/tmp/myconfig.txt`路径下搜索配置文件。如果文件不存在或无法访问，则会发生错误。

>    注意`defaults-extra-file`和`defaults-file`的区别，使用`defaults-extra-file`可以指定额外的配置文件搜索路径（也就是说那些固定的配置文件路径也会被搜索）。

#### 命令行和配置文件中启动选项的区别

如果同一个启动选项既出现在命令行中，又出现在配置文件中，那么以命令行中的启动选项为准！

### 系统变量

#### 系统变量简介

`MySQL`服务器程序运行过程中会用到许多影响程序行为的变量，它们被称为`MySQL`系统变量。

每个系统变量都有一个默认值，我们可以使用命令行或者配置文件中的选项在启动服务器时改变一些系统变量的值。大多数的系统变量的值也可以在程序运行过程中修改，而无需停止并重新启动它。

#### 查看系统变量

使用下列命令查看`MySQL`服务器程序支持的系统变量以及它们的当前值：

```
SHOW VARIABLES [LIKE 匹配的模式];
```

由于`系统变量`实在太多了，通常都会带一个`LIKE`过滤条件来查看我们需要的系统变量的值。(`LIKE`表达式后边可以跟通配符来进行模糊查询)

```
SHOW VARIABLES LIKE 'default_storage_engine'
SHOW VARIABLES like 'max_connections'
SHOW VARIABLES LIKE 'default%'
```

#### 设置系统变量

##### 通过启动选项设置

大部分的`系统变量`都可以通过启动服务器时传送启动选项的方式来进行设置。

-   通过命令行添加启动选项。

    比方说我们在启动服务器程序时用这个命令：

    ```
    mysqld --default-storage-engine=MyISAM --max-connections=10
    ```

-   通过配置文件添加启动选项。

    我们可以这样填写配置文件：

    ```
    [server]
    default-storage-engine=MyISAM
    max-connections=10
    ```

对于启动选项来说，如果启动选项名由多个单词组成，各个单词之间用短划线`-`或者下划线`_`连接起来都可以，但是对应的系统变量之间必须使用下划线`_`连接起来。

##### 服务器程序运行过程中设置

`系统变量`比较牛逼的一点就是，对于大部分系统变量来说，它们的值可以在服务器程序运行过程中进行动态修改而无需停止并重启服务器。

**设置不同作用范围的系统变量**

各个客户端都私有一份系统变量会产生这么两个问题：

-   有一些系统变量并不是针对单个客户端的。
-   一个新连接到服务器的客户端对应的系统变量的值该怎么设置？

为了解决这两个问题，设计`MySQL`的大叔提出了系统变量的`作用范围`的概念，具体来说`作用范围`分为这两种：

-   `GLOBAL`：全局变量，影响服务器的整体操作。
-   `SESSION`：会话变量，影响某个客户端连接的操作。（注：`SESSION`有个别名叫`LOCAL`）

在服务器启动时，会将每个全局变量初始化为其默认值（可以通过命令行或选项文件中指定的选项更改这些默认值）。然后服务器还为每个连接的客户端维护一组会话变量，客户端的会话变量在连接时使用相应全局变量的当前值初始化。

通过启动选项设置的系统变量的作用范围都是`GLOBAL`的，也就是对所有客户端都有效的，因为在系统启动的时候还没有客户端程序连接进来呢。

在服务器程序运行期间通过客户端程序设置系统变量的语法：

```
SET [GLOBAL|SESSION] 系统变量名 = 值;
```

或者写成这样也行：

```
SET [@@(GLOBAL|SESSION).]var_name = XXX;
```

让之后新连接到服务器的客户端都用`MyISAM`作为默认的存储引擎，

````
语句一：SET GLOBAL default_storage_engine = MyISAM;
语句二：SET @@GLOBAL.default_storage_engine = MyISAM;
````

如果只想对本客户端生效

```
语句一：SET SESSION default_storage_engine = MyISAM;
语句二：SET @@SESSION.default_storage_engine = MyISAM;
语句三：SET default_storage_engine = MyISAM;
```

如果在设置系统变量的语句中省略了作用范围，默认的作用范围就是`SESSION`。也就是说`SET 系统变量名 = 值`和`SET SESSION 系统变量名 = 值`是等价的。

###### **查看不同作用范围的系统变量**

既然`系统变量`有`作用范围`之分，那我们的`SHOW VARIABLES`语句查看的是什么`作用范围`的`系统变量`呢？

答：默认查看的是`SESSION`作用范围的系统变量。

查看系统变量的语句上加上要查看哪个`作用范围`的系统变量，就像这样：

```
SHOW [GLOBAL|SESSION] VARIABLES [LIKE 匹配的模式];
```

样例

```
SHOW SESSION VARIABLES LIKE 'default_storage_engine'
SHOW GLOBAL VARIABLES LIKE 'default_storage_engine'
```

>    小贴士： 如果某个客户端改变了某个系统变量在`GLOBAL`作用范围的值，并不会影响该系统变量在当前已经连接的客户端作用范围为`SESSION`的值，只会影响后续连入的客户端在作用范围为`SESSION`的值。

###### 注意事项

-   并不是所有系统变量都具有`GLOBAL`和`SESSION`的作用范围。
    -   有一些系统变量只具有`GLOBAL`作用范围
    -   有一些系统变量只具有`SESSION`作用范围
    -   有一些系统变量的值既具有`GLOBAL`作用范围，也具有`SESSION`作用范围

-   有些系统变量是只读的，并不能设置值。
    -   客户端是不能设置它的值的，只能在`SHOW VARIABLES`语句里查看。

#### 启动选项和系统变量的区别

`启动选项`是在程序启动时我们程序员传递的一些参数，而`系统变量`是影响服务器程序运行行为的变量，它们之间的关系如下：

-   大部分的系统变量都可以被当作启动选项传入。
-   有些系统变量是在程序运行过程中自动生成的，是不可以当作启动选项来设置，比如`auto_increment_offset`、`character_set_client`啥的。
-   有些启动选项也不是系统变量，比如`defaults-file`。

### 状态变量

`MySQL`服务器程序中维护了好多关于程序运行状态的变量，它们被称为`状态变量`。

由于`状态变量`是用来显示服务器程序运行状况的，所以它们的值只能由服务器程序自己来设置，我们程序员是不能设置的。

查看`状态变量`的语句可以这么写：

```
SHOW [GLOBAL|SESSION] STATUS [LIKE 匹配的模式];
```

如果我们不写明作用范围，默认的作用范围是`SESSION`：

```
SHOW STATUS LIKE 'thread%'
```

所有以`Thread`开头的`SESSION`作用范围的状态变量就都被展示出来了。